import { useState, useMemo } from 'react';
import { motion } from 'motion/react';
import {
  AlignLeft,
  Search,
  Link,
  MapPin,
  Copy,
  Check,
  ExternalLink,
  RotateCcw,
  Sparkles,
} from 'lucide-react';
import { toast } from 'sonner';
import { SEOResult, AIProvider, PROVIDERS } from '../lib/types';
import { formatResultsAsMarkdown } from '../lib/api';
import { SerpPreview } from './serp-preview';

interface Step4Props {
  results: SEOResult;
  provider: AIProvider;
  keyword: string;
  onStartOver: () => void;
}

function CopyButton({ text, label }: { text: string; label?: string }) {
  const [copied, setCopied] = useState(false);

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      toast.success('Copied to clipboard!');
      setTimeout(() => setCopied(false), 2000);
    } catch {
      toast.error('Failed to copy');
    }
  };

  return (
    <motion.button
      onClick={handleCopy}
      className="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs transition-all cursor-pointer"
      style={{
        background: copied ? 'rgba(0, 200, 150, 0.1)' : 'rgba(255, 255, 255, 0.03)',
        border: `1px solid ${copied ? 'rgba(0, 200, 150, 0.3)' : 'rgba(255, 255, 255, 0.06)'}`,
        color: copied ? '#00C896' : '#8B8BAD',
      }}
      whileHover={{ background: 'rgba(255, 255, 255, 0.06)' }}
      whileTap={{ scale: 0.95 }}
    >
      {copied ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
      {label || 'Copy'}
    </motion.button>
  );
}

function HighlightKeyword({ text, keyword }: { text: string; keyword: string }) {
  if (!keyword) return <>{text}</>;

  const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
  const parts = text.split(regex);

  return (
    <>
      {parts.map((part, i) =>
        regex.test(part) ? (
          <span key={i} className="keyword-highlight">
            {part}
          </span>
        ) : (
          <span key={i}>{part}</span>
        )
      )}
    </>
  );
}

function CharBadge({ count, max }: { count: number; max: number }) {
  const isOver = count > max;
  const isNear = count > max * 0.9;

  return (
    <span
      className="inline-flex items-center px-2 py-0.5 rounded text-xs"
      style={{
        background: isOver
          ? 'rgba(255, 71, 87, 0.1)'
          : isNear
          ? 'rgba(255, 184, 0, 0.1)'
          : 'rgba(0, 200, 150, 0.1)',
        color: isOver ? '#FF4757' : isNear ? '#FFB800' : '#00C896',
        border: `1px solid ${isOver ? 'rgba(255, 71, 87, 0.2)' : isNear ? 'rgba(255, 184, 0, 0.2)' : 'rgba(0, 200, 150, 0.2)'}`,
        fontWeight: 500,
      }}
    >
      {count}/{max}
      {isOver && ` (reduce by ${count - max})`}
    </span>
  );
}

const containerVariants = {
  animate: { transition: { staggerChildren: 0.12 } },
};

const cardVariants = {
  initial: { opacity: 0, y: 30 },
  animate: { opacity: 1, y: 0, transition: { duration: 0.5, ease: 'easeOut' } },
};

export function Step4Results({ results, provider, keyword, onStartOver }: Step4Props) {
  const providerInfo = PROVIDERS.find((p) => p.id === provider);
  const timestamp = useMemo(() => {
    return new Date().toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  }, []);

  const handleCopyAll = async () => {
    try {
      const markdown = formatResultsAsMarkdown(results);
      await navigator.clipboard.writeText(markdown);
      toast.success('Full output copied to clipboard!');
    } catch {
      toast.error('Failed to copy');
    }
  };

  return (
    <motion.div
      variants={containerVariants}
      initial="initial"
      animate="animate"
    >
      {/* Header */}
      <motion.div variants={cardVariants} className="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
          <h2 className="flex items-center gap-2 gradient-text" style={{ fontSize: '1.5rem', fontWeight: 700 }}>
            <Sparkles className="w-6 h-6" style={{ color: '#6C63FF' }} />
            SEO Content Ready!
          </h2>
          <p className="text-xs mt-1" style={{ color: '#8B8BAD' }}>
            Generated by {providerInfo?.name} &middot; {timestamp}
          </p>
        </div>
        <div className="flex gap-2">
          <motion.button
            onClick={handleCopyAll}
            className="px-4 py-2 rounded-xl flex items-center gap-2 text-xs cursor-pointer transition-all"
            style={{
              background: 'linear-gradient(135deg, #6C63FF, #00D4FF)',
              color: 'white',
              fontWeight: 600,
            }}
            whileHover={{ y: -1, boxShadow: '0 4px 15px rgba(108,99,255,0.3)' }}
            whileTap={{ scale: 0.97 }}
          >
            <Copy className="w-3.5 h-3.5" />
            Copy All
          </motion.button>
          <motion.button
            onClick={onStartOver}
            className="px-4 py-2 rounded-xl flex items-center gap-2 text-xs cursor-pointer transition-all"
            style={{
              background: 'transparent',
              border: '1px solid #2A2A3E',
              color: '#8B8BAD',
              fontWeight: 500,
            }}
            whileHover={{ borderColor: '#4A4A6A' }}
            whileTap={{ scale: 0.97 }}
          >
            <RotateCcw className="w-3.5 h-3.5" />
            Start Over
          </motion.button>
        </div>
      </motion.div>

      {/* Card 1 - Content Block */}
      <motion.div
        variants={cardVariants}
        className="rounded-2xl p-6 mb-4 relative overflow-hidden"
        style={{
          background: 'rgba(255, 255, 255, 0.03)',
          backdropFilter: 'blur(20px)',
          border: '1px solid rgba(255, 255, 255, 0.08)',
        }}
      >
        <div className="flex items-center justify-between mb-5">
          <div className="flex items-center gap-3">
            <div
              className="w-8 h-8 rounded-lg flex items-center justify-center"
              style={{ background: 'rgba(0, 200, 150, 0.12)' }}
            >
              <AlignLeft className="w-4 h-4" style={{ color: '#00C896' }} />
            </div>
            <span style={{ color: '#F0F0FF', fontSize: '0.9375rem', fontWeight: 600 }}>Content Block</span>
            <span
              className="px-2 py-0.5 rounded text-xs"
              style={{ background: 'rgba(0, 200, 150, 0.1)', color: '#00C896', fontWeight: 500 }}
            >
              Ready
            </span>
          </div>
          <CopyButton
            text={`## ${results.h2}\n\n${results.paragraph1}\n\n### ${results.h3}\n\n${results.paragraph2}`}
            label="Copy All"
          />
        </div>

        <div
          className="rounded-xl p-5 space-y-4"
          style={{ background: 'rgba(10, 10, 15, 0.5)', border: '1px solid rgba(42, 42, 62, 0.5)' }}
        >
          {/* H2 */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <h2
                className="gradient-text"
                style={{ fontSize: '1.25rem', fontWeight: 700 }}
              >
                {results.h2}
              </h2>
              <CopyButton text={results.h2} label="Copy H2" />
            </div>
            <div
              className="w-full h-px"
              style={{ background: 'linear-gradient(90deg, #6C63FF40, transparent)' }}
            />
          </div>

          {/* P1 */}
          <div>
            <div className="flex justify-end mb-1">
              <CopyButton text={results.paragraph1} label="Copy P1" />
            </div>
            <p style={{ color: '#C8C8E0', lineHeight: '1.8', fontSize: '0.875rem' }}>
              {results.paragraph1}
            </p>
          </div>

          {/* H3 */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <h3 className="gradient-text-pink" style={{ fontSize: '1.0625rem', fontWeight: 600 }}>
                {results.h3}
              </h3>
              <CopyButton text={results.h3} label="Copy H3" />
            </div>
          </div>

          {/* P2 */}
          <div>
            <div className="flex justify-end mb-1">
              <CopyButton text={results.paragraph2} label="Copy P2" />
            </div>
            <p style={{ color: '#C8C8E0', lineHeight: '1.8', fontSize: '0.875rem' }}>
              {results.paragraph2}
            </p>
          </div>
        </div>
      </motion.div>

      {/* Card 2 - Meta Data */}
      <motion.div
        variants={cardVariants}
        className="rounded-2xl p-6 mb-4 relative overflow-hidden"
        style={{
          background: 'rgba(255, 255, 255, 0.03)',
          backdropFilter: 'blur(20px)',
          border: '1px solid rgba(255, 255, 255, 0.08)',
        }}
      >
        <div className="flex items-center gap-3 mb-5">
          <div
            className="w-8 h-8 rounded-lg flex items-center justify-center"
            style={{ background: 'rgba(108, 99, 255, 0.12)' }}
          >
            <Search className="w-4 h-4" style={{ color: '#6C63FF' }} />
          </div>
          <span style={{ color: '#F0F0FF', fontSize: '0.9375rem', fontWeight: 600 }}>Meta Data</span>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {/* Meta Title */}
          <div
            className="rounded-xl p-4"
            style={{ background: 'rgba(10, 10, 15, 0.5)', border: '1px solid rgba(42, 42, 62, 0.5)' }}
          >
            <div className="flex items-center justify-between mb-3">
              <span className="text-xs" style={{ color: '#8B8BAD', fontWeight: 500 }}>
                Meta Title
              </span>
              <div className="flex items-center gap-2">
                <CharBadge count={results.metaTitle.length} max={55} />
                <CopyButton text={results.metaTitle} />
              </div>
            </div>
            <p style={{ color: '#F0F0FF', fontSize: '1rem', fontWeight: 500, lineHeight: '1.5' }}>
              <HighlightKeyword text={results.metaTitle} keyword={keyword} />
            </p>
          </div>

          {/* Meta Description */}
          <div
            className="rounded-xl p-4"
            style={{ background: 'rgba(10, 10, 15, 0.5)', border: '1px solid rgba(42, 42, 62, 0.5)' }}
          >
            <div className="flex items-center justify-between mb-3">
              <span className="text-xs" style={{ color: '#8B8BAD', fontWeight: 500 }}>
                Meta Description
              </span>
              <div className="flex items-center gap-2">
                <CharBadge count={results.metaDescription.length} max={145} />
                <CopyButton text={results.metaDescription} />
              </div>
            </div>
            <p style={{ color: '#C8C8E0', fontSize: '0.875rem', lineHeight: '1.7' }}>
              <HighlightKeyword text={results.metaDescription} keyword={keyword} />
            </p>
          </div>
        </div>

        {/* SERP Preview */}
        <SerpPreview title={results.metaTitle} description={results.metaDescription} />
      </motion.div>

      {/* Card 3 - Internal Links */}
      <motion.div
        variants={cardVariants}
        className="rounded-2xl p-6 mb-4 relative overflow-hidden"
        style={{
          background: 'rgba(255, 255, 255, 0.03)',
          backdropFilter: 'blur(20px)',
          border: '1px solid rgba(255, 255, 255, 0.08)',
        }}
      >
        <div className="flex items-center gap-3 mb-5">
          <div
            className="w-8 h-8 rounded-lg flex items-center justify-center"
            style={{ background: 'rgba(0, 212, 255, 0.12)' }}
          >
            <Link className="w-4 h-4" style={{ color: '#00D4FF' }} />
          </div>
          <span style={{ color: '#F0F0FF', fontSize: '0.9375rem', fontWeight: 600 }}>Internal Links</span>
        </div>

        <div className="space-y-3">
          {results.internalLinks.map((link, i) => (
            <motion.div
              key={i}
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: i * 0.1 }}
              className="rounded-xl p-4"
              style={{ background: 'rgba(10, 10, 15, 0.5)', border: '1px solid rgba(42, 42, 62, 0.5)' }}
            >
              <div className="flex items-start gap-3">
                <span
                  className="mt-0.5 w-6 h-6 rounded-md flex items-center justify-center text-xs shrink-0"
                  style={{ background: 'rgba(108, 99, 255, 0.1)', color: '#6C63FF', fontWeight: 600 }}
                >
                  {String(i + 1).padStart(2, '0')}
                </span>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-2">
                    <span
                      className="px-2 py-0.5 rounded text-xs"
                      style={{
                        background: link.isLive ? 'rgba(0, 200, 150, 0.1)' : 'rgba(255, 184, 0, 0.1)',
                        color: link.isLive ? '#00C896' : '#FFB800',
                        fontWeight: 500,
                      }}
                    >
                      {link.isLive ? 'LIVE' : 'UNVERIFIED'}
                    </span>
                  </div>
                  <p className="mb-1">
                    <span className="text-xs" style={{ color: '#8B8BAD' }}>
                      Anchor:{' '}
                    </span>
                    <span style={{ color: '#F0F0FF', fontStyle: 'italic', fontSize: '0.875rem' }}>
                      "{link.anchorText}"
                    </span>
                  </p>
                  <p className="truncate mb-3" title={link.url}>
                    <span className="text-xs" style={{ color: '#8B8BAD' }}>
                      URL:{' '}
                    </span>
                    <span className="text-xs" style={{ color: '#00D4FF' }}>
                      {link.url}
                    </span>
                  </p>
                  <div className="flex gap-2">
                    <CopyButton text={link.anchorText} label="Copy Anchor" />
                    <CopyButton text={link.url} label="Copy URL" />
                    <a
                      href={link.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs transition-all"
                      style={{
                        background: 'rgba(255, 255, 255, 0.03)',
                        border: '1px solid rgba(255, 255, 255, 0.06)',
                        color: '#8B8BAD',
                      }}
                    >
                      <ExternalLink className="w-3 h-3" />
                      Open
                    </a>
                  </div>
                </div>
              </div>
            </motion.div>
          ))}
        </div>
      </motion.div>

      {/* Card 4 - Placement Recommendation */}
      <motion.div
        variants={cardVariants}
        className="rounded-2xl p-6 mb-8 relative overflow-hidden"
        style={{
          background: 'rgba(255, 255, 255, 0.03)',
          backdropFilter: 'blur(20px)',
          border: '1px solid rgba(255, 255, 255, 0.08)',
        }}
      >
        <div className="flex items-center gap-3 mb-5">
          <div
            className="w-8 h-8 rounded-lg flex items-center justify-center"
            style={{ background: 'rgba(255, 184, 0, 0.12)' }}
          >
            <MapPin className="w-4 h-4" style={{ color: '#FFB800' }} />
          </div>
          <span style={{ color: '#F0F0FF', fontSize: '0.9375rem', fontWeight: 600 }}>Placement Recommendation</span>
          <span
            className="px-2 py-0.5 rounded text-xs"
            style={{ background: 'rgba(255, 184, 0, 0.1)', color: '#FFB800', fontWeight: 500 }}
          >
            Tip
          </span>
        </div>

        <div
          className="rounded-xl p-4 relative"
          style={{
            background: 'rgba(255, 184, 0, 0.03)',
            borderLeft: '3px solid #FFB800',
          }}
        >
          <p style={{ color: '#C8C8E0', fontStyle: 'italic', lineHeight: '1.7', fontSize: '0.875rem' }}>
            {results.placementRecommendation}
          </p>
        </div>
      </motion.div>

      {/* Bottom Actions */}
      <motion.div variants={cardVariants} className="flex flex-col sm:flex-row gap-3">
        <motion.button
          onClick={onStartOver}
          className="flex-1 py-3.5 rounded-xl flex items-center justify-center gap-2 transition-all cursor-pointer"
          style={{
            background: 'transparent',
            border: '1px solid #2A2A3E',
            color: '#8B8BAD',
            fontSize: '0.9375rem',
            fontWeight: 500,
          }}
          whileHover={{ borderColor: '#4A4A6A' }}
          whileTap={{ scale: 0.98 }}
        >
          <RotateCcw className="w-4 h-4" />
          Start Over
        </motion.button>
        <motion.button
          onClick={handleCopyAll}
          className="flex-1 py-3.5 rounded-xl flex items-center justify-center gap-2 text-white transition-all cursor-pointer"
          style={{
            background: 'linear-gradient(135deg, #6C63FF, #00D4FF)',
            fontSize: '0.9375rem',
            fontWeight: 600,
          }}
          whileHover={{ y: -2, boxShadow: '0 8px 30px rgba(108, 99, 255, 0.35)' }}
          whileTap={{ scale: 0.98 }}
        >
          <Copy className="w-4 h-4" />
          Copy Full Output
        </motion.button>
      </motion.div>
    </motion.div>
  );
}